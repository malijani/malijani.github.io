#!/usr/bin/env bash

# --- Configuration ---
SOURCE_BRANCH="master"
DEPLOY_BRANCH="gh-pages"
DRY_RUN_DIR="dry_run_site"

# --- Style and Color Definitions ---
RED=$(tput setaf 1)
GREEN=$(tput setaf 2)
YELLOW=$(tput setaf 3)
CYAN=$(tput setaf 6)
BOLD=$(tput bold)
RESET=$(tput sgr0)
TERM_WIDTH=$(tput cols)

# --- Argument Parsing ---
URL=""
DRY_RUN=false
while [[ "$#" -gt 0 ]]; do
    case $1 in
        --url) URL="$2"; shift ;;
        --dry-run) DRY_RUN=true ;;
        *) echo -e "${BOLD}${RED}Unknown parameter passed: $1${RESET}"; exit 1 ;;
    esac
    shift
done

if [[ -z "$URL" ]]; then
  echo -e "${BOLD}${RED}Usage: $0 --url <your-website-url> [--dry-run]${RESET}"
  echo -e "${YELLOW}Example: $0 --url https://alijaniam.test${RESET}"
  exit 1
fi
URL_HOST=$(echo "$URL" | awk -F/ '{print $3}')

# --- Pre-flight Checks ---
echo -e "${BOLD}${CYAN}Checking out ${SOURCE_BRANCH} branch...${RESET}"
git checkout "$SOURCE_BRANCH" &>/dev/null

if [[ -n $(git status --porcelain) ]]; then
    echo -e "${BOLD}${RED}Uncommitted changes detected on ${SOURCE_BRANCH}. Please commit or stash them. Aborting...${RESET}"
    exit 1
fi

# --- Download Logic ---
if [[ "$DRY_RUN" == false ]] && [[ -d "$DRY_RUN_DIR" ]]; then
    echo -e "\n${BOLD}${GREEN}Found pre-downloaded files in '${DRY_RUN_DIR}/'. Using them for deployment.${RESET}"
else
    echo -e "\n${BOLD}${CYAN}Checking if URL is accessible...${RESET}"
    if ! wget --spider --no-check-certificate "$URL" &>/dev/null; then
        echo -e "${BOLD}${RED}URL '$URL' is not accessible. Aborting...${RESET}"
        exit 1
    fi
    echo -e "${BOLD}${GREEN}URL is up! Starting download.${RESET}"

    rm -rf "$URL_HOST" "$DRY_RUN_DIR"
    
    echo -e "\n${BOLD}${CYAN}Downloading site from ${URL}...${RESET}"
    # ADDED --progress flag for a clean progress bar
    wget -mkEpnp --no-check-certificate --progress=bar:force:noscroll "$URL"
    
    if [ ! -d "$URL_HOST" ]; then
        echo -e "\n${BOLD}${RED}Failed to download site. Directory '${URL_HOST}' not found. Aborting...${RESET}"
        exit 1
    fi
    echo -e "\n${BOLD}${GREEN}Site downloaded successfully.${RESET}"

    if [[ "$DRY_RUN" == true ]]; then
        echo -e "\n${BOLD}${CYAN}Dry run mode enabled. Moving downloaded files to '${DRY_RUN_DIR}'...${RESET}"
        mv "$URL_HOST" "$DRY_RUN_DIR"
        echo -e "\n${BOLD}${GREEN}Dry run complete. Inspect the downloaded site in the '${DRY_RUN_DIR}/' directory.${RESET}"
        exit 0
    fi
fi

# --- Full Deployment (only runs if not in dry-run mode) ---
echo -e "\n${BOLD}${CYAN}Proceeding with full deployment...${RESET}"

COMMIT=$(git rev-parse --short HEAD)
PREV_COMMIT=$(git rev-parse --short @"${DEPLOY_BRANCH}" 2>/dev/null || echo "initial")
REPO_URL=$(git config --get remote.origin.url | sed -e 's/git@github.com:/https:\/\/github.com\//' -e 's/\.git$//')
COMMIT_URL="${REPO_URL}/commit/${COMMIT}"
COMPARE_URL="${REPO_URL}/compare/${PREV_COMMIT}...${COMMIT}"

echo -e "\n${BOLD}${CYAN}Checking out ${DEPLOY_BRANCH} branch...${RESET}"
git checkout "$DEPLOY_BRANCH"
BRANCH=$(git rev-parse --abbrev-ref HEAD)
if [[ "$BRANCH" != "$DEPLOY_BRANCH" ]]; then
  echo -e "${BOLD}${RED}Failed to switch to ${DEPLOY_BRANCH} branch. Aborting...${RESET}"
  exit 1
fi

shopt -s extglob
echo -e "\n${BOLD}${CYAN}Cleaning old files in ${DEPLOY_BRANCH} branch...${RESET}"
rm -rv !(".gitignore"|"CNAME"|".git"|".nojekyll"|".vscode"|"*.sh")
shopt -u extglob

echo -e "\n${BOLD}${CYAN}Moving new site contents to root...${RESET}"
if [[ -d "$DRY_RUN_DIR" ]]; then
    mv "$DRY_RUN_DIR"/* .
else
    mv "$URL_HOST"/* .
fi

echo -e "\n${BOLD}${CYAN}Adding changes to git...${RESET}"
git add .
echo -e "\n${BOLD}${CYAN}Committing changes...${RESET}"
git commit -m "deploy: ${COMMIT} from ${SOURCE_BRANCH}"
echo -e "\n${BOLD}${CYAN}Pushing to ${DEPLOY_BRANCH} branch...${RESET}"
git push -u origin "$DEPLOY_BRANCH"

echo -e "\n${BOLD}${CYAN}Switching back to ${SOURCE_BRANCH} branch...${RESET}"
git checkout "$SOURCE_BRANCH"
rm -rf "$URL_HOST" "$DRY_RUN_DIR"

# --- Deployment Summary Banner ---
draw_line() { printf "${BOLD}${GREEN}╔"; for ((i=2;i<TERM_WIDTH;i++)); do printf "═"; done; printf "╗${RESET}\n"; }
draw_middle() { local l="$1" r="$2"; local p=$((TERM_WIDTH - ${#l} - ${#r} - 4)); printf "${BOLD}${GREEN}║${RESET} ${BOLD}%s${RESET}%*s ${BOLD}${GREEN}║${RESET}\n" "$l" "$p" "$r"; }
echo -e "\n"; draw_line; draw_middle "  Deployment to ${DEPLOY_BRANCH} successful! " ""; draw_middle "  View source commit:" "${COMMIT_URL}"; draw_middle "  Compare changes:" "${COMPARE_URL}"; printf "${BOLD}${GREEN}╚"; for ((i=2;i<TERM_WIDTH;i++)); do printf "═"; done; printf "╝${RESET}\n"
